# Distributing Tracing

## Server Request Correlation

### Prior to v2.7.1

Support for correlating requests between the Server request and any client events (PageView, Ajax (Dependency)) required the returned HTML page to contain some dynamic JavaScript so that as part of the SDK initialization a callback function is called to populate the Server-Side Operation Id.

Simplified Example using Razor and the snippet

```C#
<script>
!function(T,l,y){<removed snippet code>,{
    src: "https://js.monitor.azure.com/scripts/b/ai.2.min.js", // The SDK URL Source
    onInit: function(appInsights) {
        var serverId = "@this.Context.GetRequestTelemetry().Context.Operation.Id";
        appInsights.context.telemetryContext.parentID = serverId;
    },
    cfg: { // Application Insights Configuration
        instrumentationKey: "<your instrumentation key>"
    }});
</script>
```

This approach is error prone and can very easy lead to invalid javascript being as part of the page.

And when not using the snippet you have to find "somewhere" (generally global) to hold the Operation Id so that when your SDK initialization bundle is loaded it can access and populate `appInsights.context.telemetryContext.parentID` before the first page view event is sent.

### Since v2.7.1 - Page Meta tag and Server-Timing Header Support

Since v2.7.1 the SDK will attempt to populate the `parentID` of the telemetryTrace context by locating and reading values from the DOM during SDK initialization.

This provides a much simpler process than previously required as there is no additional JavaScript required whether using the snippet or the NPM packages. You do however, still need to add a ```<meta />``` tag to the returned ```<html />``` or a header as part of the ```HTTP``` response generated by your server so that the SDK can access the Server-Side context values.

So now you just add a meta tag to the returned page, or (assuming razor) you can just update your base razor template to add the required meta tag.

```csharp
<head>
<meta name="traceparent" content="@this.Context.GetRequestTelemetry().Context.TraceParentHeader" />
</head>
```

> :bulb: **Note**
>
> This assumes that there is a property called `TraceParentHeader` that returns a properly formatted `traceparent` header value.

That is all that is required when not using the snippet as the SDK will read this value from the page, so your SDK initialization code does not need to do anything special.

And if you are using the snippet, then there is no special ```onInit()``` required, it's just the based detauls values.

Simplified example still using the snippet

```csharp
<script>
!function(T,l,y){<removed snippet code>,{
    src: "https://js.monitor.azure.com/scripts/b/ai.2.min.js", // The SDK URL Source
    cfg: { // Application Insights Configuration
        instrumentationKey: "<your instrumentation key>"
    }});
</script>
```

Generally, when running in a browser the SDK (and JavaScript) does not have any access the returned headers of the page. There is an exception when running on a modern browser and this is the [Server-Timing Headers](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Server-Timing), modern browsers exposes the returned values of this header to JavaScript via the performance server timings and therefore, they can be accessed via the performance API. Which currently includes the main page as part of the `navigation` resource.

```typescript
    let navPerf = performance.getEntriesByType("navigation");
    console.log(entries[0].serverTiming);
    // 0: PerformanceServerTiming {name: "cache", duration: 23.2, description: "Cache Read"}
    // 1: PerformanceServerTiming {name: "db", duration: 53, description: ""}
    // 2: PerformanceServerTiming {name: "app", duration: 47.2, description: ""}
            traceParent = parseTraceParent(_getTraceParentValue((navPerf.length > 0 ? navPerf[0] : {} as any).serverTiming).description);
```

So, if the SDK fails to locate a meta-tag value for the supported values it will also look for any returned value within the description field of the Server-Timing header.

> :bulb: **Note**
>
> As mentioned above not all browsers currently support accessing the [serverTiming API](https://caniuse.com/?search=serverTiming) so if your users are not using a browser that supports this feature the SDK will not be able to populate and provide the server-side correlation.

So the current order of processing is `<meta />` and then `serverTiming` for each value as follows
- 'traceparent' (meta-tag)
- 'traceparent' (server-timing)
- 'Request-Id' (meta-tag)
- 'Request-Id' (server-timing)

So when more than 1 valid value is present, the SDK will stop processing after is has read and validated the first value.

This means that you can now just add a Server-Timing header to your response via your normal controller with the same values, so no need to update your View templates used to generate the resulting html. This also means your returned "views" could be pre-generated or static to provide better performance.

### Supported page meta tags

#### traceparent

```html
<head>
    <meta name="traceparent" content="00-4bf92f3577b34da6a3ce929d0e0e4736-00f067aa0ba902b7-01">
</head>
```

If the provided traceparent value is valid as per the [W3C Trace Parent Header spec](https://www.w3.org/TR/trace-context/#traceparent-header) and successfully parsed the parentID of the telemetryTrace context will be set to the `parent-id` value from the value, which will be "00f067aa0ba902b7" using the above example. As per the W3C specification, if the value is considered to be invalid none of the values will be used.

```typescript
    let parentId = appInsights.context.telemetryTrace.parentID;
    if (parent === "00f067aa0ba902b7") {
        // This will be true when the page includes the above meta tag somewhere on the page.
    }
```

#### Request-Id

This value is only checked when no valid traceparent was located.

```html
<head>
    <meta name="Request-Id" content="|4bf92f3577b34da6a3ce929d0e0e4736.00f067aa0ba902b7">
</head>
```

As with the traceparent value if the value cannot be decoded or the values are not considered to be valid they will be ignored. And for legacy purposes the Request-Id may contain an optional trailing "."

```html
<head>
    <meta name="Request-Id" content="|4bf92f3577b34da6a3ce929d0e0e4736.00f067aa0ba902b7.">
</head>
```

 For format used is the Application Insights specific `Request-Id` that is also used for Ajax requests. as with the traceparent "00f067aa0ba902b7" will be used.

```typescript
    let parentId = appInsights.context.telemetryTrace.parentID;
    if (parent === "00f067aa0ba902b7") {
        // This will be true when the page includes the above meta tag somewhere on the page.
    }
```

### Supported Server-Timing Header

When no valid meta tag was located the SDK will check for support within the browser for the [PerformanceServerTiming](https://developer.mozilla.org/en-US/docs/Web/API/PerformanceServerTiming) and if available it will attempt to use the value within the `description` field of the named Server-Timing header value. Other named header values may exist, the SDK only looks for the named values as below. If more than 1 value is present (using the same name) only the first processed value will be used.

```http
HTTP/1.1 200 OK
Cache-Control: no-cache
Content-Type: text/html; charset=utf-8
Server-Timing: name1;desc="value1", name2;desc="value2"
Date: Tue, 02 Nov 2021 22:32:34 GMT

<html>
...
</html>
```

```typescript
    let navPerf = performance.getEntriesByType("navigation");
    console.log(entries[0].serverTiming);
    // 0: PerformanceServerTiming {name: "name1", description: "value1"}
    // 1: PerformanceServerTiming {name: "name2", description: "value2"}
```

The order of the headers does not control which value is "selected", the SDK will always check in the defined order and use the first validated value regardless of the order transmitted as part of the HTTP request.

#### traceparent

Example request headers

```http
HTTP/1.1 200 OK
Cache-Control: no-cache
Content-Type: text/html; charset=utf-8
Server-Timing: traceparent;desc="00-4bf92f3577b34da6a3ce929d0e0e4736-00f067aa0ba902b7-01"
Date: Tue, 02 Nov 2021 22:32:34 GMT

<html>
...
</html>
```

Using the above example HTTP request the value of the `Server-Timing` can be accessed as below and the SDK automatically performs this lookup during initialization.

```typescript
    let navPerf = performance.getEntriesByType("navigation");
    console.log(entries[0].serverTiming);
    // 0: PerformanceServerTiming {name: "traceparent", description: "00-4bf92f3577b34da6a3ce929d0e0e4736-00f067aa0ba902b7-01"}

    // So after the SDK is initialized the value will be as follows
    let parentId = appInsights.context.telemetryTrace.parentID;
    if (parent === "00f067aa0ba902b7") {
        // This will be true when the page includes the above meta tag somewhere on the page.
    }
```

#### Request-Id

Example request headers, as with the meta tag the value may contain am optional trailing '.' character.

```http
HTTP/1.1 200 OK
Cache-Control: no-cache
Content-Type: text/html; charset=utf-8
Server-Timing: Request-Id;desc="|4bf92f3577b34da6a3ce929d0e0e4736.00f067aa0ba902b7."
Date: Tue, 02 Nov 2021 22:32:34 GMT

<html>
...
</html>
```

Using the above example HTTP request the value of the `Server-Timing` can be accessed as below and the SDK automatically performs this lookup during initialization.

```typescript
    let navPerf = performance.getEntriesByType("navigation");
    console.log(entries[0].serverTiming);
    // 0: PerformanceServerTiming {name: "traceparent", description: "|4bf92f3577b34da6a3ce929d0e0e4736.00f067aa0ba902b7"}

    // So after the SDK is initialized the value will be as follows
    let parentId = appInsights.context.telemetryTrace.parentID;
    if (parent === "00f067aa0ba902b7") {
        // This will be true when the page includes the above meta tag somewhere on the page.
    }
```
